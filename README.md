# NetSpy - Simple Network Traffic Logger via LD_PRELOAD

NetSpy is a C++ Linux preloadable library that intercepts network-related function calls for a specific executable and logs all incoming and outgoing network traffic in PCAP format for later visualization with Wireshark.

This approach avoids the need for root privileges or special capabilities, as the library only sees the traffic generated by the specific application it's loaded with.

![](screenshot.png)

## Features

- Intercepts all common network function calls: socket, bind, connect, accept, send, recv, sendto, recvfrom, etc.
- Uses JSON for function prototype specification and automatic C++ binding generation
- **PCAP-over-IP streaming** for real-time network traffic analysis
- Logs network traffic in PCAP format compatible with Wireshark
- Supports both TCP and UDP over IPv4 and IPv6
- Thread-safe with minimal performance overhead
- Automatically names output files based on executable name and process ID
- Modern C++ design with proper class encapsulation
- Google Test unit tests with comprehensive coverage

## Prerequisites

To compile and use NetSpy, you need:

- G++ or a compatible C++ compiler (with C++17 support)
- libpcap development headers and libraries
- Python 3 for code generation
- Standard Linux development tools

On Debian/Ubuntu-based systems, install dependencies with:

```
sudo apt-get install g++ libpcap-dev python3
```

## Compilation and Installation

Compile the library using the provided CMake build system:

```
mkdir build
cd build
cmake ..
make
ctest
```

The build process includes the following steps:
1. Parse network_functions.json to generate C++ bindings
2. Generate header (generated_bindings_header.hpp) and implementation (generated_bindings_impl.hpp) files
3. Compile the final library (libnetspy.so)

### System Installation

To install NetSpy system-wide:

```
sudo make install
```

This will install:
- Library: `/usr/local/lib/libnetspy.so`
- Headers: `/usr/local/include/netspy/`
- Helper scripts: `/usr/local/share/netspy/`
- Documentation: `/usr/local/share/doc/netspy/`

### Custom Installation Path

To install to a custom location:

```
cmake -DCMAKE_INSTALL_PREFIX=/path/to/install ..
make
make install
```

## Usage

NetSpy provides both a convenient CLI frontend and direct LD_PRELOAD usage.

### CLI Frontend (Recommended)

The `netspy` command provides an easy-to-use interface:

```bash
# Basic usage - saves to PCAP file
netspy curl google.com

# Stream to Wireshark in real-time
netspy --wireshark curl google.com

# Stream to custom port
netspy --stream 8080 curl google.com

# Use Python stream viewer
netspy --stream-client curl google.com

# Save to specific directory
netspy --output /tmp curl google.com

# Quiet mode (minimal output)
netspy --quiet firefox
```

### Direct LD_PRELOAD Usage

For advanced users or integration into scripts:

```bash
# Using local build
LD_PRELOAD=./libnetspy.so curl google.com

# Using installed version
LD_PRELOAD=/usr/local/lib/libnetspy.so curl google.com
```

By default, the library creates a PCAP file named `[executable_name]_[pid].pcap` in the current directory. For example, `curl_12345.pcap`.

## PCAP-over-IP Real-time Streaming

NetSpy supports real-time PCAP streaming over TCP, allowing you to analyze network traffic as it happens without writing to disk.

### Enabling PCAP-over-IP

#### Using CLI Frontend (Recommended)

```bash
# Stream to default port 57012 with automatic Wireshark
netspy --wireshark curl google.com

# Stream to custom port
netspy --stream 8080 curl google.com

# Use built-in Python stream client
netspy --stream-client curl google.com
```

#### Using Direct Environment Variables

```bash
# Stream to default port 57012
NETSPY_PCAP_OVER_IP_PORT=57012 LD_PRELOAD=./libnetspy.so curl google.com

# Stream to custom port
NETSPY_PCAP_OVER_IP_PORT=8080 LD_PRELOAD=./libnetspy.so your_application
```

### Connecting with Wireshark

```bash
# Automatic (CLI frontend - recommended)
netspy --wireshark curl google.com

# Using the included helper script
./examples/wireshark_example.sh curl google.com

# Manual Wireshark connection
wireshark -k -i TCP@127.0.0.1:57012
```

### Python Client Examples

NetSpy includes Python examples for custom traffic analysis:

```bash
# Built-in stream client (via CLI)
netspy --stream-client curl google.com

# Direct Python client usage
python3 examples/pcap_stream_client.py

# Advanced filtering and analysis
python3 examples/traffic_filter.py --filter "tcp and port 80" --stats

# Save filtered packets to file
python3 examples/traffic_filter.py --filter "https" --save https_traffic.pcap
```

### Remote Monitoring

PCAP-over-IP enables remote network monitoring:

```bash
# On the target machine
NETSPY_PCAP_OVER_IP_PORT=57012 LD_PRELOAD=./libnetspy.so your_app

# On the analysis machine
python3 examples/pcap_stream_client.py target-host.example.com 57012
wireshark -k -i TCP@target-host.example.com:57012
```

## Viewing the Captured Traffic

### PCAP Files
You can open generated PCAP files with Wireshark:

```bash
wireshark [executable_name]_[pid].pcap
```

### Real-time Stream
For real-time analysis, use PCAP-over-IP streaming as described above.

## Modifying Function List

To add or modify the intercepted network functions:

1. Edit the `network_functions.json` file
2. Rebuild the library with `make clean && make`

## Limitations

- Limited to TCP and UDP protocols
- The library assumes that file descriptors below 4096 are used for sockets

## Debugging

The library has debug output enabled by default. To disable debug output, change `constexpr bool DEBUG_ENABLED = true;` to `constexpr bool DEBUG_ENABLED = false;` in network_interceptor.hpp and recompile.

## How It Works

NetSpy uses:

1. The `LD_PRELOAD` mechanism to intercept library calls
2. JSON-based function prototype specification for maintainability
3. Python code generation to create C++ bindings
4. C++ classes for clean code organization
5. libpcap for PCAP file generation
